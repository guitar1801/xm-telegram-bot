from playwright.sync_api import sync_playwright

XM_USERNAME = "CH350846966"
XM_PASSWORD = "Guitar2541@"

def fetch_xm_users_today():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()

        page.goto("https://mypartners.xm.com/login", wait_until="networkidle")
        page.fill('input[name="email"]', XM_USERNAME)
        page.fill('input[name="password"]', XM_PASSWORD)
        page.click('button[type="submit"]')
        page.wait_for_load_state("networkidle")

        page.click("text=รายงาน")
        page.click("text=เทรดเดอร์ลิสต์")
        page.wait_for_load_state("networkidle")

        page.select_option('select[name="report"]', label="การลงทะเบียนเทรดเดอร์ใหม่")
        page.select_option('select[name="time_period"]', label="วันนี้")
        page.select_option('select[name="country"]', label="ทั้งหมด")
        page.select_option('select[name="campaign"]', label="ทั้งหมด")

        page.click("text=สร้างรายงาน")
        page.wait_for_load_state("networkidle")

        rows = page.query_selector_all("table tbody tr")
        ids = set()

        for row in rows:
            cells = row.query_selector_all("td")
            if cells:
                cid = cells[0].inner_text().strip()
                if cid:
                    ids.add(cid)

        browser.close()

        users = sorted(list(ids))
        return len(users), users
